# قواعد خصم نسبة المندوب من المرتجعات

## نظرة عامة
تم تعديل منطق خصم نسبة المندوب عند إرجاع المنتجات ليطابق القواعد الجديدة المطلوبة.

## القواعد الجديدة

### القاعدة 1: رصيد دائن أكبر من مبلغ المرتجع
**الشرط:** إذا كان للعميل رصيد دائن (Credit Balance) أكبر من إجمالي مبلغ المرتجعات

**الحساب:**
- Credit = abs(balance) إذا balance < 0
- إذا Credit > returnAmount:
  - **نسبة خصم المندوب = 0%**
  - **لا يتم خصم أي مبلغ**

**مثال:**
- رصيد العميل: -500 ج.م (رصيد دائن = 500 ج.م)
- مبلغ المرتجع: 300 ج.م
- النتيجة: لا خصم (500 > 300)

---

### القاعدة 2: رصيد مدين أقل من مبلغ المرتجع
**الشرط:** إذا كان العميل لديه رصيد مدين (Debit Balance) أقل من إجمالي مبلغ المرتجعات

**الحساب:**
- Debit = balance إذا balance > 0
- إذا Debit < returnAmount:
  - الفرق (x) = returnAmount - Debit
  - **نسبة خصم المندوب = 2% من (x)**
  - **يتم خصم هذه القيمة من نسبة تحصيلات المندوب الحالية**

**مثال:**
- رصيد العميل: 200 ج.م (دين)
- مبلغ المرتجع: 500 ج.م
- الفرق (x) = 500 - 200 = 300 ج.م
- الخصم = 2% × 300 = 6 ج.م

---

### القاعدة 3: رصيد العميل = 0 أو رصيد دائن (Credit <= returnAmount)
**الشرط:** إذا كان رصيد العميل = 0 أو كان لديه رصيد دائن (ولكن Credit <= returnAmount)

**الحساب:**
- **نسبة خصم المندوب = 2% من كامل مبلغ المرتجع**
- **يتم خصم هذا المبلغ من نسبة تحصيلات المندوب الحالية**

**أمثلة:**

**مثال 1: رصيد = 0**
- رصيد العميل: 0 ج.م
- مبلغ المرتجع: 500 ج.م
- الخصم = 2% × 500 = 10 ج.م

**مثال 2: رصيد دائن <= مبلغ المرتجع**
- رصيد العميل: -200 ج.م (رصيد دائن = 200 ج.م)
- مبلغ المرتجع: 500 ج.م
- النتيجة: 200 <= 500، لذا تطبق القاعدة 3
- الخصم = 2% × 500 = 10 ج.م

---

## الملفات المعدلة

### 1. `includes/return_salary_deduction.php`
**التعديلات:**
- ✅ تحديث منطق حساب الخصم ليطابق القواعد الجديدة الثلاث
- ✅ حساب رصيد الدين (Debit) ورصيد الدائن (Credit) بشكل منفصل
- ✅ تطبيق القواعد بالترتيب الصحيح
- ✅ تسجيل تفاصيل الحساب في audit_logs

**الدالة الرئيسية:**
```php
function applyReturnSalaryDeduction(int $returnId, ?int $salesRepId = null, ?int $processedBy = null): array
```

**المنطق:**
1. جلب بيانات المرتجع ورصيد العميل قبل المرتجع
2. حساب Debit و Credit قبل المرتجع
3. تطبيق القواعد بالترتيب:
   - القاعدة 1: Credit > returnAmount → لا خصم
   - القاعدة 2: Debit < returnAmount → خصم 2% من الفرق
   - القاعدة 3: balance = 0 أو Credit <= returnAmount → خصم 2% من كامل المرتجع
4. تطبيق الخصم على راتب المندوب
5. تسجيل في audit_logs و salaries

### 2. `includes/return_financial_processor.php`
**التعديلات:**
- ✅ حفظ الرصيد القديم قبل المعالجة المالية
- ✅ تسجيل الرصيد القديم في audit_logs لاستخدامه في حساب خصم المندوب

---

## سير العمل

### 1. عند الموافقة على المرتجع:
```
1. processReturnFinancials() - معالجة التسوية المالية
   ├─ حفظ الرصيد القديم
   ├─ حساب الرصيد الجديد
   └─ تسجيل في audit_logs (مع old_balance)

2. returnProductsToVehicleInventory() - إرجاع المنتجات للمخزون

3. applyReturnSalaryDeduction() - حساب خصم المندوب
   ├─ جلب الرصيد القديم من audit_logs
   ├─ حساب Debit و Credit
   ├─ تطبيق القواعد الجديدة
   ├─ خصم من راتب المندوب
   └─ تسجيل في audit_logs و salaries
```

### 2. منع التكرار:
- ✅ التحقق من عدم تطبيق الخصم مسبقاً من audit_logs
- ✅ استخدام معاملات قاعدة البيانات (Transactions) لضمان التكامل

---

## تسجيل الخصم

### 1. في جدول `salaries`:
- تحديث عمود `deductions` بإضافة مبلغ الخصم
- تحديث عمود `total_amount` بخصم مبلغ الخصم

### 2. في جدول `audit_logs`:
- تسجيل تفصيلي لكل عملية خصم
- يتضمن:
  - القاعدة المستخدمة
  - رصيد العميل قبل المرتجع
  - مبلغ المرتجع
  - مبلغ الخصم
  - تفاصيل الحساب

---

## أمثلة عملية

### مثال 1: تطبيق القاعدة 1
```
العميل: أحمد
رصيد العميل قبل المرتجع: -1000 ج.م (رصيد دائن = 1000 ج.م)
مبلغ المرتجع: 500 ج.م

الحساب:
- Credit = 1000 ج.م
- returnAmount = 500 ج.م
- 1000 > 500 → تطبق القاعدة 1
- الخصم = 0 ج.م
```

### مثال 2: تطبيق القاعدة 2
```
العميل: محمد
رصيد العميل قبل المرتجع: 300 ج.م (دين)
مبلغ المرتجع: 800 ج.م

الحساب:
- Debit = 300 ج.م
- returnAmount = 800 ج.م
- 300 < 800 → تطبق القاعدة 2
- الفرق (x) = 800 - 300 = 500 ج.م
- الخصم = 2% × 500 = 10 ج.م
```

### مثال 3: تطبيق القاعدة 3 (رصيد = 0)
```
العميل: علي
رصيد العميل قبل المرتجع: 0 ج.م
مبلغ المرتجع: 600 ج.م

الحساب:
- balance = 0 → تطبق القاعدة 3
- الخصم = 2% × 600 = 12 ج.م
```

### مثال 4: تطبيق القاعدة 3 (رصيد دائن <= المرتجع)
```
العميل: خالد
رصيد العميل قبل المرتجع: -150 ج.م (رصيد دائن = 150 ج.م)
مبلغ المرتجع: 400 ج.م

الحساب:
- Credit = 150 ج.م
- returnAmount = 400 ج.م
- 150 <= 400 → تطبق القاعدة 3
- الخصم = 2% × 400 = 8 ج.م
```

---

## ملاحظات مهمة

1. **الترتيب مهم:** يتم تطبيق القواعد بالترتيب (1 → 2 → 3)
2. **الرصيد قبل المرتجع:** يتم الحصول عليه من audit_logs لضمان الدقة
3. **منع التكرار:** يتم التحقق من عدم تطبيق الخصم مسبقاً
4. **التكامل:** جميع العمليات تتم داخل معاملات قاعدة البيانات
5. **التسجيل:** كل خطوة مسجلة في audit_logs للتدقيق

---

**تاريخ التحديث:** 2024
**الحالة:** ✅ مكتمل وجاهز للاستخدام

