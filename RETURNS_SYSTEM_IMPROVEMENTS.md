# تحسينات نظام المرتجعات

## نظرة عامة
تم تحسين نظام إرجاع المنتجات ليعمل وفق المتطلبات التالية:

## 1. إرسال طلب الموافقة
- ✅ عندما يقوم المندوب بعمل إرجاع منتج من صفحة العملاء الخاصة به، يتم إرسال طلب موافقة تلقائياً إلى صفحة المدير
- ✅ رابط صفحة الموافقات: `manager.php?page=approvals&section=returns`
- ✅ يتم عرض طلبات المرتجعات المعلقة في قسم "طلبات المرتجعات"

## 2. معالجة المرتجع بعد الموافقة

### أ. إرجاع المنتجات للمخزون
- ✅ يتم إرجاع جميع بيانات المنتج المرتجع كاملة للنظام
- ✅ إذا كان رقم التشغيلة (Batch Number) موجود في مخزن سيارة المندوب:
  - يتم إضافة كمية المنتج المرتجع إلى الكمية الحالية الموجودة في مخزن السيارة
- ✅ إذا لم يكن Batch Number موجود:
  - يتم إنشاء سجل جديد في مخزن السيارة مع جميع بيانات المنتج

**الملفات المعدلة:**
- `includes/return_inventory_manager.php` - تم تحسين البحث عن Batch Number باستخدام:
  - `finished_batch_id` (ID رقم التشغيلة)
  - `finished_batch_number` (نص رقم التشغيلة)
  - البحث بدون batch للمنتجات التي لا تحتوي على batch number

### ب. تسجيل العملية
- ✅ يتم تسجيل عملية المرتجع في سجلات المرتجعات في:
  - جدول `returns` - تحديث الحالة إلى `processed`
  - جدول `audit_logs` - تسجيل تفصيلي لكل خطوة:
    - `process_return_financials` - معالجة التسوية المالية
    - `return_to_inventory` - إرجاع المنتجات للمخزون
    - `approve_return` - موافقة المدير على المرتجع

## 3. الحساب المالي للمرتجعات

### القواعد المطبقة:
1. **حساب إجمالي قيمة المرتجعات للعميل**
   - يتم حساب المبلغ الإجمالي من جميع عناصر المرتجع

2. **إضافة المبلغ كرصيد سالب للعميل**
   - المبلغ يتم إضافته كرصيد سالب (Credit) للعميل

3. **معالجة رصيد الديون (Debit)**
   - إذا كان للعميل رصيد ديون (balance > 0):
     - يتم خصم قيمة المرتجع من رصيد الديون
     - إذا كان رصيد الديون أقل من قيمة المرتجع:
       - يتم خصم المتاح من الديون حتى يصل إلى صفر
       - ثم يُضاف المبلغ المتبقي إلى الرصيد الدائن (Credit)

4. **معالجة الرصيد الدائن (Credit)**
   - إذا لم يكن للعميل رصيد ديون (balance <= 0):
     - تتم إضافة المبلغ كاملاً إلى الرصيد الدائن (Credit)

**الملفات المعدلة:**
- `includes/return_financial_processor.php` - تم تحسين منطق الحساب المالي ليطابق المتطلبات بدقة

## 4. التحقق من صحة البيانات (Validation)

تم إضافة التحقق من صحة البيانات قبل تنفيذ المرتجع:

- ✅ التحقق من صحة معرف العميل
- ✅ التحقق من أن مبلغ المرتجع أكبر من صفر
- ✅ التحقق من وجود العميل في النظام
- ✅ التحقق من صحة عناصر المرتجع:
  - معرف المنتج صالح
  - الكمية أكبر من صفر
  - المنتج موجود في النظام
- ✅ التحقق من وجود المندوب إذا كان محدداً

**الملفات المعدلة:**
- `api/approve_return.php` - تم إضافة validation شامل قبل معالجة المرتجع

## 5. الملفات المعدلة

### الملفات الرئيسية:
1. **`includes/return_inventory_manager.php`**
   - تحسين البحث عن Batch Number في مخزن السيارة
   - إضافة الكمية للكمية الحالية إذا كان Batch موجود
   - إنشاء سجل جديد إذا لم يكن Batch موجود
   - تحسين التسجيل في audit_logs

2. **`includes/return_financial_processor.php`**
   - تحسين منطق الحساب المالي ليطابق المتطلبات
   - معالجة حالات الدين والرصيد الدائن بشكل صحيح
   - تحسين التسجيل في audit_logs

3. **`api/approve_return.php`**
   - إضافة validation شامل للبيانات
   - تحسين معالجة الأخطاء
   - التأكد من تسجيل كل خطوة

### الملفات غير المعدلة (تعمل بالفعل بشكل صحيح):
- `api/return_requests.php` - إنشاء طلب المرتجع وإرسال الموافقة
- `modules/manager/return_approvals.php` - عرض طلبات المرتجعات للمدير
- `includes/approval_system.php` - نظام الموافقات

## 6. سير العمل الكامل

### أ. إنشاء طلب المرتجع (من قبل المندوب):
1. المندوب يختار العميل والمنتجات من صفحة العملاء
2. يتم إنشاء سجل في جدول `returns` بحالة `pending`
3. يتم إنشاء عناصر المرتجع في جدول `return_items`
4. يتم إرسال طلب موافقة تلقائياً إلى المدير
5. يظهر الطلب في `manager.php?page=approvals&section=returns`

### ب. الموافقة على المرتجع (من قبل المدير):
1. المدير يرى طلب المرتجع في صفحة الموافقات
2. عند الموافقة، يتم تنفيذ الخطوات التالية بالترتيب:
   a. **التحقق من صحة البيانات** (validation)
   b. **تحديث حالة المرتجع** إلى `approved`
   c. **معالجة التسوية المالية**:
      - حساب الرصيد الجديد للعميل
      - خصم من الدين أو إضافة للرصيد الدائن
   d. **إرجاع المنتجات للمخزون**:
      - البحث عن Batch Number في مخزن السيارة
      - إضافة الكمية للكمية الحالية أو إنشاء سجل جديد
   e. **تسجيل كل خطوة** في audit_logs
   f. **تحديث حالة المرتجع** إلى `processed`

## 7. ملاحظات مهمة

- ✅ جميع العمليات تتم داخل معاملات قاعدة البيانات (Transactions) لضمان التكامل
- ✅ يتم تسجيل كل خطوة في سجلات التدقيق (audit_logs)
- ✅ النظام يدعم المنتجات مع أو بدون Batch Numbers
- ✅ يتم البحث عن Batch Number باستخدام ID أو النص
- ✅ الحساب المالي يطابق المتطلبات بدقة

## 8. الاختبار

يُنصح باختبار السيناريوهات التالية:

1. **مرتجع من عميل بدون ديون**: يجب إضافة المبلغ كرصيد دائن
2. **مرتجع من عميل مدين**: يجب خصم المبلغ من الدين
3. **مرتجع أكبر من الدين**: يجب خصم الدين بالكامل وإضافة الباقي كرصيد دائن
4. **مرتجع مع Batch Number موجود**: يجب إضافة الكمية للكمية الحالية
5. **مرتجع مع Batch Number غير موجود**: يجب إنشاء سجل جديد
6. **مرتجع بدون Batch Number**: يجب إنشاء سجل جديد بدون batch

---

**تاريخ التحديث:** 2024
**الحالة:** ✅ مكتمل وجاهز للاستخدام

