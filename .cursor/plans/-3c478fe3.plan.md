<!-- 3c478fe3-2ff4-402d-bad6-89f864d7e9f4 3a48f1c2-34f4-4772-8045-16051a43954e -->
# خطة تنفيذ نظام المرتجعات الجديد

## المرحلة 1: حذف وإزالة النظام القديم

### 1.1 حذف الصفحات والوحدات القديمة

- حذف `modules/sales/returns.php` (استبدال بنظام جديد)
- حذف `modules/manager/returns.php`
- حذف `modules/manager/return_approvals.php` (استبدال بنظام موافقات جديد)
- مراجعة وحذف أي مراجع للمرتجعات في `modules/accountant/`

### 1.2 حذف الروابط من القوائم الجانبية

- إزالة رابط "المرتجعات" من `templates/sidebar_sales.php` (سطر 94-99)
- إزالة رابط "المرتجعات والاستبدال" من `templates/navbar_menu.php` (سطر 88-93)
- إزالة المراجع من `dashboard/sales.php` (سطر 1119-1127)
- إزالة المراجع من `dashboard/manager.php` (سطر 800-807، 282-286، 497-500)

### 1.3 حذف/تعطيل API endpoints القديمة

- مراجعة `api/return_requests.php` واستبدالها بـ API جديدة
- مراجعة `api/invoice_returns.php` وربطها بالنظام الجديد
- مراجعة `api/approve_return.php` وتحديثها للنظام الجديد
- حذف أي ملفات API قديمة غير مستخدمة

### 1.4 تنظيف جداول قاعدة البيانات (اختياري)

- **ملاحظة**: قد نترك الجداول القديمة للتوافق مع البيانات التاريخية أو ننشئ جداول جديدة
- جدول `returns` - سنستخدمه بعد تحديثه
- جدول `return_items` - سنستخدمه بعد تحديثه

## المرحلة 2: بناء النظام الجديد - البنية التحتية

### 2.1 إنشاء/تحديث جداول قاعدة البيانات

**ملف**: `database/migrations/create_new_returns_system.sql`

#### جدول المرتجعات الجديد (تحديث `returns`)

```sql
-- تحديث جدول returns ليدعم النظام الجديد
ALTER TABLE returns 
  ADD COLUMN batch_number_id INT(11) DEFAULT NULL AFTER invoice_id,
  ADD COLUMN condition_type ENUM('normal','damaged','expired') DEFAULT 'normal',
  ADD COLUMN return_quantity DECIMAL(10,2) NOT NULL DEFAULT 0.00,
  ADD INDEX idx_batch_number_id (batch_number_id);
```

#### جدول المرتجعات التالفة الجديد

```sql
CREATE TABLE IF NOT EXISTS `damaged_returns` (
  `id` INT(11) NOT NULL AUTO_INCREMENT,
  `return_id` INT(11) NOT NULL,
  `return_item_id` INT(11) NOT NULL,
  `product_id` INT(11) NOT NULL,
  `batch_number_id` INT(11) DEFAULT NULL,
  `quantity` DECIMAL(10,2) NOT NULL,
  `damage_reason` TEXT DEFAULT NULL,
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `return_id` (`return_id`),
  KEY `return_item_id` (`return_item_id`),
  KEY `product_id` (`product_id`),
  KEY `batch_number_id` (`batch_number_id`),
  CONSTRAINT `damaged_returns_ibfk_1` FOREIGN KEY (`return_id`) REFERENCES `returns` (`id`) ON DELETE CASCADE,
  CONSTRAINT `damaged_returns_ibfk_2` FOREIGN KEY (`return_item_id`) REFERENCES `return_items` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 2.2 إنشاء ملفات النظام الأساسية

#### ملف المعالجة الرئيسي

- `includes/new_returns_handler.php` - معالجة منطق الإرجاع
- `includes/return_inventory_manager.php` - إدارة إرجاع المنتجات للمخزون
- `includes/return_financial_processor.php` - معالجة التسويات المالية
- `includes/return_salary_deduction.php` - معالجة خصومات مرتب المندوب

## المرحلة 3: واجهة المستخدم - نقطة الدخول

### 3.1 تحديث صفحة العملاء لإضافة زر "سجل مشتريات العميل"

**ملف**: `modules/sales/customers.php`

- إضافة زر جديد بجانب زر "سجل العميل" الحالي
- زر يفتح modal جديد باسم "سجل مشتريات العميل"

### 3.2 إنشاء Modal جديد لسجل المشتريات

**ملف**: `modules/sales/customer_purchase_history_modal.php` (component جديد)

**المحتوى المطلوب**:

1. **قسم بيانات العميل**:

   - الاسم، الهاتف، العنوان

2. **جدول سجل المشتريات**:

   - رقم الفاتورة
   - رقم التشغيلة (إن وجد) - من `invoice_items` و `sales_batch_numbers`
   - اسم المنتج
   - الكمية
   - سعر الوحدة
   - السعر الإجمالي
   - تاريخ الشراء
   - أزرار: "إرجاع كامل" / "إرجاع جزئي"

3. **فلترة وبحث**:

   - البحث بالاسم
   - البحث برقم التشغيلة
   - فلترة بالتاريخ

### 3.3 API endpoint لسجل المشتريات مع أرقام التشغيلات

**ملف**: `api/customer_purchase_history.php` (جديد)

**Endpoints**:

- `GET ?action=get_history&customer_id=X` - جلب سجل المشتريات مع تفاصيل التشغيلات
- `GET ?action=search&customer_id=X&batch_number=Y` - البحث برقم التشغيلة
- `GET ?action=search&customer_id=X&product_name=Y` - البحث بالاسم

## المرحلة 4: صفحة المبيعات والتحصيلات - قسم المرتجعات

### 4.1 إضافة Tab ثالث في صفحة المبيعات والتحصيلات

**ملف**: `dashboard/sales.php` (سطر 477-490)

إضافة Tab جديد:

```php
<li class="nav-item">
    <button class="nav-link" id="returns-tab" data-bs-toggle="pill" data-bs-target="#returns-section">
        <i class="bi bi-arrow-return-left"></i>
        <span>المرتجعات</span>
    </button>
</li>
```

### 4.2 إنشاء صفحة المرتجعات الجديدة

**ملف**: `modules/sales/new_returns.php` (جديد)

**الجدول يعرض**:

- رقم المرتجع
- رقم التشغيلة
- اسم العميل
- الكمية المرتجعة
- التاريخ
- سبب الإرجاع
- الحالة (قيد المراجعة / مقبول / مرفوض)
- إجراءات (عرض التفاصيل، طباعة)

**الفلترة**:

- بالحالة
- بالتاريخ
- برقم التشغيلة
- باسم العميل

## المرحلة 5: منطق الإرجاع

### 5.1 معالجة طلب الإرجاع

**ملف**: `includes/new_returns_handler.php`

**الوظيفة الرئيسية**: `createReturnRequest($customerId, $invoiceId, $items, $reason)`

**الخطوات**:

1. التحقق من صحة البيانات (الكمية المرتجعة ≤ الكمية الأصلية)
2. إنشاء سجل في جدول `returns` بحالة `pending`
3. إنشاء سجلات في `return_items` مع حفظ رقم التشغيلة
4. إنشاء طلب موافقة في نظام الموافقات
5. إرجاع رقم المرتجع

### 5.2 إعادة المنتجات للمخزون (بعد الموافقة)

**ملف**: `includes/return_inventory_manager.php`

**الوظيفة**: `returnProductsToVehicleInventory($returnId)`

**الخطوات**:

1. جلب بيانات المرتجع المعتمد
2. لكل عنصر في المرتجع:

   - تحديد سيارة المندوب منشئ الطلب
   - العثور على مخزن السيارة
   - إضافة الكمية إلى `vehicle_inventory` بنفس `batch_number_id`
   - إذا كان المنتج تالفاً، إضافة إلى `damaged_returns`

3. تسجيل حركة في `inventory_movements`

### 5.3 معالجة المنتجات التالفة

**الوظيفة**: `handleDamagedReturn($returnItemId, $damageReason)`

- إضافة سجل في `damaged_returns`
- عدم إرجاع الكمية للمخزون العادي
- إمكانية إنشاء قسم منفصل للعرض لاحقاً

## المرحلة 6: التسويات المالية

### 6.1 معالجة رصيد العميل

**ملف**: `includes/return_financial_processor.php`

**الوظيفة**: `processReturnFinancials($returnId)`

**المنطق**:

1. جلب رصيد العميل الحالي (`customer.balance`)
2. حساب مبلغ المرتجع الإجمالي
3. **الحالة 1**: إذا كان العميل مدين (balance > 0):

   - خصم من الدين: `new_balance = current_balance - return_amount`

4. **الحالة 2**: إذا كان غير مدين (balance <= 0):

   - خصم من الرصيد الدائن: `new_balance = current_balance - return_amount` (يصبح أكثر سالبية)

5. **الحالة 3**: إذا كان المرتجع أكبر من الدين:

   - `debt_reduction = min(return_amount, current_balance)`
   - `credit_addition = return_amount - debt_reduction`
   - `new_balance = -credit_addition`

### 6.2 تحديث رصيد العميل

- استخدام `UPDATE customers SET balance = ? WHERE id = ?`
- تسجيل في `audit_logs`

## المرحلة 7: خصومات مرتب المندوب

### 7.1 حساب الخصم حسب الحالة

**ملف**: `includes/return_salary_deduction.php`

**الوظيفة**: `applyReturnSalaryDeduction($returnId, $salesRepId)`

**المنطق**:

1. جلب بيانات المرتجع والعميل
2. **الحالة 1**: إذا كان العميل مدين (كان مدين قبل المرتجع):

   - لا يتم خصم أي مبلغ (`deduction_amount = 0`)

3. **الحالة 2**: إذا كان العميل غير مدين:

   - `deduction_amount = return_amount * 0.02`
   - خصم من مرتب المندوب

4. **الحالة 3**: إذا كان جزء يغطي الدين والجزء الآخر رصيد دائن:

   - حساب `credit_portion = return_amount - debt_before_return`
   - `deduction_amount = credit_portion * 0.02`

5. تطبيق الخصم على جدول `salaries`
6. إرسال تنبيه للمندوب

### 7.2 نظام التنبيهات

- استخدام `includes/notifications.php` لإرسال تنبيه للمندوب
- نص التنبيه: "تم خصم [المبلغ] من مرتبك بسبب مرتجع [رقم المرتجع]"

## المرحلة 8: نظام الموافقات

### 8.1 تكامل مع نظام الموافقات الموجود

**ملف**: `includes/approval_system.php`

- استخدام `createApprovalRequest()` الموجود
- نوع الموافقة: `'return_request'`
- بعد الموافقة: استدعاء `approveReturn()` الذي يقوم بـ:

  1. تحديث حالة المرتجع إلى `approved`
  2. استدعاء `returnProductsToVehicleInventory()`
  3. استدعاء `processReturnFinancials()`
  4. استدعاء `applyReturnSalaryDeduction()`

### 8.2 صفحة موافقات المرتجعات للمدير

**ملف**: `modules/manager/return_approvals.php` (جديد أو تحديث الموجود)

- عرض المرتجعات قيد المراجعة
- زر الموافقة / الرفض
- عرض التفاصيل قبل الموافقة

## المرحلة 9: منع الأخطاء المنطقية

### 9.1 التحقق من الكميات

**في**: `includes/new_returns_handler.php`

```php
// التحقق من أن الكمية المرتجعة ≤ الكمية المشتراة
foreach ($items as $item) {
    $originalQuantity = getOriginalPurchaseQuantity($invoiceId, $item['product_id'], $item['batch_number_id']);
    $returnedQuantity = getAlreadyReturnedQuantity($invoiceId, $item['product_id'], $item['batch_number_id']);
    $availableToReturn = $originalQuantity - $returnedQuantity;
    
    if ($item['quantity'] > $availableToReturn) {
        throw new Exception("الكمية المرتجعة ({$item['quantity']}) أكبر من المتاح ({$availableToReturn})");
    }
}
```

### 9.2 إجبار الموافقة قبل المعالجة

- كل مرتجع يبدأ بحالة `pending`
- لا يمكن تنفيذ الإرجاع للمخزون إلا بعد الموافقة
- في `approveReturn()`: التحقق من الحالة قبل المعالجة

## المرحلة 10: صفحة المدير - جدول المرتجعات

### 10.1 إضافة قسم المرتجعات في dashboard المدير

**ملف**: `dashboard/manager.php`

- إنشاء صفحة `modules/manager/returns_overview.php` (جديد)
- جدول مماثل لصفحة المندوب لكن مع عرض جميع المرتجعات
- إمكانية فلترة حسب المندوب

## المرحلة 11: API Endpoints الجديدة

### 11.1 إنشاء API موحد للمرتجعات

**ملف**: `api/new_returns_api.php` (جديد)

**Endpoints**:

- `POST /api/new_returns_api.php?action=create` - إنشاء طلب إرجاع
- `GET /api/new_returns_api.php?action=list` - عرض قائمة المرتجعات
- `GET /api/new_returns_api.php?action=details&id=X` - تفاصيل مرتجع
- `POST /api/new_returns_api.php?action=approve&id=X` - موافقة (للمدير)
- `POST /api/new_returns_api.php?action=reject&id=X` - رفض (للمدير)

## المرحلة 12: الاختبار والتكامل

### 12.1 اختبار السيناريو المذكور

- عميل يشتري 10 قطع (رقم تشغيلة B123، سعر 100 جنيه)
- شراء على الحساب → العميل مدين
- بعد أسبوع: إرجاع 2 قطع
- التحقق من:
  - تسجيل الإرجاع
  - إرجاع المخزون بنفس رقم التشغيلة
  - خصم 200 جنيه من دين العميل
  - عدم خصم من مرتب المندوب (لأن العميل كان مدين)

### 12.2 حالات اختبار إضافية

- إرجاع كامل
- إرجاع جزئي متعدد
- إرجاع منتج تالف
- إرجاع من عميل غير مدين (اختبار خصم 2%)
- إرجاع أكبر من الدين (اختبار التحويل لرصيد دائن)

## الملفات الرئيسية للتعديل/الإنشاء

### ملفات للحذف:

- `modules/sales/returns.php` (استبدال)
- `modules/manager/returns.php` (استبدال)

### ملفات للتعديل:

- `dashboard/sales.php` - إضافة tab المرتجعات
- `modules/sales/customers.php` - إضافة زر سجل المشتريات
- `dashboard/manager.php` - إزالة المراجع القديمة وإضافة الجديدة
- `templates/sidebar_sales.php` - تحديث الروابط
- `templates/navbar_menu.php` - تحديث الروابط

### ملفات جديدة:

- `modules/sales/new_returns.php` - صفحة المرتجعات الجديدة
- `modules/sales/customer_purchase_history_modal.php` - Modal سجل المشتريات
- `modules/manager/return_approvals.php` - صفحة موافقات المرتجعات
- `modules/manager/returns_overview.php` - نظرة عامة للمدير
- `includes/new_returns_handler.php` - معالج الإرجاع
- `includes/return_inventory_manager.php` - إدارة المخزون
- `includes/return_financial_processor.php` - المعالجة المالية
- `includes/return_salary_deduction.php` - خصومات المرتب
- `api/new_returns_api.php` - API الموحد
- `api/customer_purchase_history.php` - API سجل المشتريات
- `database/migrations/create_new_returns_system.sql` - Migration

### ملفات قاعدة البيانات:

- تحديث جدول `returns`
- إنشاء جدول `damaged_returns`
- تحديث جدول `return_items` لدعم أرقام التشغيلات بشكل أفضل