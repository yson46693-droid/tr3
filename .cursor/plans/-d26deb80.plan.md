---
name: خطة تحسين سرعة التنقل في الشريط الجانبي
overview: ""
todos:
  - id: 4ac0ed6e-6299-46b1-bdfa-9ccb0e0ca2b1
    content: تقليل تأخير شاشة التحميل من 800ms إلى 100ms في footer.php السطر 441
    status: pending
  - id: cfe015df-6e8a-4281-a7cf-ce1560917e15
    content: إضافة data-no-splash='true' لجميع روابط الشريط الجانبي في homeline_sidebar.php السطور 537-538
    status: pending
  - id: 179099e8-aeaa-46b6-921f-39c15bac352c
    content: تحسين معالج النقرات في footer.php لإضافة فحص data-no-splash وتسجيل التنقل الداخلي
    status: pending
  - id: 4e7b143b-584c-4a68-b0a4-9441726938f7
    content: تحسين منطق pageshow في footer.php لتخطي منطق الجلسات للروابط الداخلية
    status: pending
  - id: 326fe1b5-0e42-42fd-8a54-14afc80d825f
    content: تحسين مستمعات الأحداث باستخدام throttling للأحداث الثقيلة في footer.php السطور 517-519
    status: pending
---

# خطة تحسين سرعة التنقل في الشريط الجانبي

## المشكلة

التنقل بين الصفحات في الشريط الجانبي بطيء بسبب:

- تأخير 800ms في شاشة التحميل
- استدعاءات API متعددة لكل تنقل (create/check/delete splash session)
- معالجة جميع الروابط بنفس المنطق بدون تمييز بين الداخلية والخارجية
- مستمعات أحداث غير محسّنة

## الحلول

### 1. تقليل تأخير شاشة التحميل

**الملف:** `templates/footer.php`

**السطر:** 441

**التعديل:** تقليل التأخير من 800ms إلى 100ms في دالة `hideSplashScreen()`

```javascript
// من:
}, 800); // تأخير 800ms لإظهار الشاشة

// إلى:
}, 100); // تقليل التأخير إلى 100ms للاستجابة السريعة
```

### 2. إضافة data-no-splash لروابط الشريط الجانبي

**الملف:** `templates/homeline_sidebar.php`

**السطور:** 537-538

**التعديل:** إضافة `data-no-splash="true"` لجميع روابط القائمة الجانبية

```php
// من:
<a class="nav-link <?php echo $item['active'] ? 'active' : ''; ?>" 
   href="<?php echo htmlspecialchars($item['url']); ?>">

// إلى:
<a class="nav-link <?php echo $item['active'] ? 'active' : ''; ?>" 
   href="<?php echo htmlspecialchars($item['url']); ?>"
   data-no-splash="true">
```

### 3. تحسين معالج النقرات للروابط

**الملف:** `templates/footer.php`

**السطور:** 687-718

**التعديل:**

- إضافة فحص `data-no-splash` في بداية المعالج
- تسجيل التنقل الداخلي في sessionStorage
- تخطي إظهار شاشة التحميل للروابط الداخلية
```javascript
document.addEventListener('click', function(e) {
    const link = e.target.closest('a');
    
    // تخطي الروابط التي لديها data-no-splash (روابط الشريط الجانبي)
    if (link && link.hasAttribute('data-no-splash')) {
        // تسجيل أن هذا تنقل داخلي لتخطي منطق الجلسات في pageshow
        sessionStorage.setItem('internalNavigation', 'true');
        return; // لا تعرض شاشة التحميل للروابط الداخلية
    }
    
    // باقي المنطق الحالي...
});
```


### 4. تحسين منطق pageshow لتخطي الروابط الداخلية

**الملف:** `templates/footer.php`

**السطور:** 522-563

**التعديل:** إضافة فحص للتنقل الداخلي في بداية معالج `pageshow` لتخطي منطق الجلسات

```javascript
window.addEventListener('pageshow', function(event) {
    // إذا كانت الصفحة من cache (back/forward)، لا تظهر splash screen
    if (event.persisted && pageLoader) {
        // ... الكود الحالي ...
        return;
    }
    
    // التحقق من أن الصفحة قادمة من رابط داخلي
    const isInternalNavigation = sessionStorage.getItem('internalNavigation') === 'true';
    sessionStorage.removeItem('internalNavigation'); // تنظيف بعد الاستخدام
    
    // إذا كان التنقل داخلي، تخطي منطق الجلسات بالكامل
    if (isInternalNavigation) {
        if (pageLoader) {
            pageLoader.classList.add('hidden');
            if (pageLoader.style) {
                pageLoader.style.display = 'none';
            }
        }
        if (dashboardMain) {
            dashboardMain.classList.add('content-fade-in');
        }
        return; // تخطي كل منطق الجلسات والـ API calls
    }
    
    // باقي المنطق الحالي للصفحات الخارجية...
});
```

### 5. تحسين مستمعات الأحداث

**الملف:** `templates/footer.php`

**السطور:** 517-519

**التعديل:** استخدام throttling للأحداث الثقيلة (mousemove, scroll) لتقليل عدد الاستدعاءات

```javascript
// إضافة دالة throttled للأحداث الثقيلة
let inactivityTimerThrottle = null;
function throttledResetInactivityTimer() {
    if (inactivityTimerThrottle) {
        return; // تخطي إذا كان هناك استدعاء قريب
    }
    inactivityTimerThrottle = setTimeout(function() {
        resetInactivityTimer();
        inactivityTimerThrottle = null;
    }, 100); // throttle إلى 100ms
}

// الأحداث الثقيلة مع throttling و passive
['mousemove', 'scroll'].forEach(function(event) {
    document.addEventListener(event, throttledResetInactivityTimer, { passive: true });
});

// الأحداث الأخرى بدون throttling
['mousedown', 'keypress', 'touchstart'].forEach(function(event) {
    document.addEventListener(event, resetInactivityTimer, true);
});
```

## النتيجة المتوقعة

- تقليل زمن التنقل من ~800-1200ms إلى ~100-200ms
- تخطي استدعاءات API غير الضرورية للروابط الداخلية
- تحسين استجابة الواجهة بشكل عام
- تقليل الحمل على الخادم من خلال تقليل استدعاءات API

## الترتيب التنفيذي

1. التعديل 1: تقليل التأخير (أبسط وأسرع تأثير)
2. التعديل 2: إضافة data-no-splash (تمهيد للتعديلات التالية)
3. التعديل 3: تحسين معالج النقرات (يعتمد على التعديل 2)
4. التعديل 4: تحسين pageshow (يعتمد على التعديل 3)
5. التعديل 5: تحسين مستمعات الأحداث (مستقل)