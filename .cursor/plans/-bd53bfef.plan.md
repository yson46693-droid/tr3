<!-- bd53bfef-7995-437a-9b65-add9dea827b5 54748fce-e12d-42df-9792-ed66b01ececb -->
# خطة تنفيذ نظام استبدال المنتجات

## نظرة عامة

تنفيذ نظام استبدال المنتجات للعملاء في صفحة `sales.php?page=customers` يتضمن:

- إضافة زر "استبدال" في جدول العملاء
- إنشاء مودال لعملية الاستبدال مع جدولين (مشتريات العميل ومخزن السيارة)
- تنفيذ منطق الاستبدال مع ثلاث حالات مالية
- تحديث جميع الجداول المرتبطة

## الملفات التي سيتم تعديلها/إنشاؤها

### 1. `modules/sales/customers.php`

**التعديلات:**

- إضافة زر "استبدال" بجانب أزرار "تحصيل" و"سجل المشتريات" و"إرجاع" (حوالي السطر 3346)
- إضافة مودال الاستبدال (`replacementModal`) بعد مودال إضافة العميل
- إضافة JavaScript لإدارة عملية الاستبدال (فتح المودال، تحميل البيانات، حساب الإجماليات)
- إضافة معالج AJAX لتحميل مشتريات العميل ومخزن السيارة
- إضافة معالج POST لتنفيذ عملية الاستبدال

### 2. `api/process_replacement.php` (ملف جديد)

**الوظيفة:** معالجة عملية الاستبدال

- التحقق من صحة البيانات
- حساب الإجماليات والفرق
- تطبيق منطق الاستبدال (3 حالات)
- تحديث الجداول:
- `vehicle_inventory`: تحديث الكميات
- `customers`: تحديث الرصيد
- `product_exchanges`: تسجيل عملية الاستبدال
- `collections`: إضافة/خصم من خزنة المندوب (إن لزم)
- `salaries`: خصم 2% في الحالة الثالثة

### 3. `api/get_replacement_data.php` (ملف جديد)

**الوظيفة:** جلب البيانات للاستبدال

- جلب مشتريات العميل (من `invoice_items` و `invoices`)
- جلب مخزن سيارة المندوب (من `vehicle_inventory`)
- إرجاع البيانات بصيغة JSON

## منطق الاستبدال

### الحالة 1: customer_total == car_total

- لا تغيير في رصيد العميل
- لا خصم من المندوب
- لا تغيير في الخزنة

### الحالة 2: customer_total < car_total

- diff = car_total - customer_total
- إضافة diff إلى رصيد العميل المدين (`balance += diff`)
- إضافة diff إلى خزنة المندوب (من خلال `collections` بعلامة إيجابية)
- تحديث المبيعات الإجمالية/اليومية/الشهرية للمندوب

### الحالة 3: customer_total > car_total

- diff = customer_total - car_total
- إذا كان رصيد العميل == 0 أو رصيد دائن:
- إضافة diff إلى الرصيد الدائن (`balance -= diff`)
- خصم diff من خزنة المندوب (من خلال `collections` بعلامة سالبة)
- خصم 2% من diff من راتب المندوب (`salaries.deductions += diff * 0.02`)

## تحديثات الجداول

### `vehicle_inventory`

- إضافة الكميات المسترجعة من العميل
- خصم الكميات المعطاة للعميل

### `customers`

- تحديث `balance` حسب منطق الاستبدال

### `product_exchanges` (جدول موجود)

- إنشاء سجل جديد للاستبدال مع تفاصيل:
- `customer_id`, `sales_rep_id`
- `original_total`, `new_total`, `difference_amount`
- `exchange_date`, `status`, `created_by`

### `collections`

- إضافة سجل تحصيل (موجب/سالب) حسب الحالة

### `salaries`

- تحديث `deductions` في حالة 3 (إضافة 2% من diff)

## بنية المودال

### جدول مشتريات العميل

- الأعمدة: المنتج، الكمية، السعر، checkbox
- البيانات من `invoice_items` و `invoices` مع استبعاد المرتجعات/الاستبدالات السابقة

### جدول مخزن السيارة

- الأعمدة: المنتج، الكمية المتاحة، السعر، checkbox
- البيانات من `vehicle_inventory` حيث `vehicle_id` مرتبط بـ `driver_id` (المندوب)

### زر تنفيذ

- يعرض ملخص العملية
- ينفذ العملية عبر AJAX

## الأمان والتحقق

- استخدام Prepared Statements لجميع الاستعلامات
- التحقق من صلاحيات المستخدم
- التحقق من وجود المنتجات والكميات المتاحة
- استخدام Transactions لضمان التكامل
- تسجيل جميع العمليات في Audit Log

## JavaScript المطلوب

1. **فتح المودال:** عند الضغط على زر "استبدال"
2. **تحميل البيانات:** AJAX لجلب المشتريات والمخزن
3. **حساب الإجماليات:** عند تحديد/إلغاء تحديد المنتجات
4. **عرض الملخص:** قبل التنفيذ
5. **تنفيذ العملية:** إرسال POST إلى `api/process_replacement.php`
6. **التحديث:** إعادة تحميل الصفحة بعد النجاح

## ملاحظات تقنية

- استخدام `getSalesRepForCustomer()` للحصول على المندوب
- استخدام `vehicles` للحصول على `vehicle_id` من `driver_id`
- استخدام دالة `refreshSalesCommissionForUser()` لتحديث الراتب
- تحديث مبيعات اليوم/الشهر في جدول `invoices` أو `sales`
- استخدام `formatCurrency()` لعرض المبالغ