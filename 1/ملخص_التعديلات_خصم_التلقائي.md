# ملخص التعديلات: نظام الخصم التلقائي لمواد التعبئة

## نظرة عامة
تم تطبيق نظام خصم تلقائي لمواد التعبئة عند إنشاء تشغيلات الإنتاج من القوالب. النظام يكتشف مواد معينة في القالب ويقوم تلقائياً بخصم مواد أخرى بناءً على كمية الإنتاج.

---

## التعديلات المطبقة

### 1. PKG-042 → PKG-001 (1 لكل 12 وحدة)

**الموقع:** `modules/production/production.php`

**التفاصيل:**
- **المادة المحفزة:** PKG-042
- **المادة المستهدفة:** PKG-001
- **الشرط:** كمية الإنتاج >= 12
- **معدل الخصم:** 1 من PKG-001 لكل 12 وحدة منتجة

**التعديلات:**
1. إضافة متغير `$templateIncludesPkg042 = false;` (السطر 2353)
2. إضافة منطق اكتشاف PKG-042 في حلقة معالجة مواد التعبئة (السطور 2779-2809)
3. إضافة منطق الخصم التلقائي (السطور 3063-3174)

**أمثلة:**
- كمية 12 → خصم 1 من PKG-001
- كمية 24 → خصم 2 من PKG-001
- كمية 36 → خصم 3 من PKG-001

---

### 2. PKG-011 → PKG-001 (1 لكل 12 وحدة)

**الموقع:** `modules/production/production.php`

**التفاصيل:**
- **المادة المحفزة:** PKG-011
- **المادة المستهدفة:** PKG-001
- **الشرط:** كمية الإنتاج >= 12
- **معدل الخصم:** 1 من PKG-001 لكل 12 وحدة منتجة

**التعديلات:**
1. إضافة متغير `$templateIncludesPkg011 = false;` (السطر 2354)
2. إضافة منطق اكتشاف PKG-011 في حلقة معالجة مواد التعبئة (السطور 2813-2843)
3. إضافة منطق الخصم التلقائي (السطور 3211-3322)

**أمثلة:**
- كمية 12 → خصم 1 من PKG-001
- كمية 24 → خصم 2 من PKG-001
- كمية 36 → خصم 3 من PKG-001

---

### 3. PKG-036 → PKG-002 (1 لكل 6 وحدة)

**الموقع:** `modules/production/production.php`

**التفاصيل:**
- **المادة المحفزة:** PKG-036
- **المادة المستهدفة:** PKG-002
- **الشرط:** كمية الإنتاج >= 6
- **معدل الخصم:** 1 من PKG-002 لكل 6 وحدات منتجة

**التعديلات:**
1. إضافة متغير `$templateIncludesPkg036 = false;` (السطر 2356)
2. إضافة منطق اكتشاف PKG-036 في حلقة معالجة مواد التعبئة (السطور 2881-2911)
3. إضافة منطق الخصم التلقائي (السطور 3507-3618)

**أمثلة:**
- كمية 6 → خصم 1 من PKG-002
- كمية 12 → خصم 2 من PKG-002
- كمية 18 → خصم 3 من PKG-002

---

## آلية العمل

### 1. مرحلة الاكتشاف
- يتم فحص جميع مواد التعبئة في القالب أثناء معالجة عناصر القالب
- يتم البحث عن المادة المحفزة (مثل PKG-042) بعدة طرق:
  - مقارنة مباشرة مع `material_code`
  - البحث في قاعدة البيانات باستخدام `material_id`
  - تطبيع الكود ومقارنته

### 2. مرحلة الخصم التلقائي
- بعد معالجة جميع مواد التعبئة من القالب
- يتم التحقق من وجود المادة المحفزة وكمية الإنتاج
- إذا تحقق الشرط:
  1. البحث عن المادة المستهدفة (مثل PKG-001) في قاعدة البيانات
  2. حساب الكمية المطلوبة للخصم بناءً على كمية الإنتاج
  3. محاولة الدمج مع عنصر موجود في `$materialsConsumption['packaging']`
  4. إضافة عنصر جديد إذا لم يتم الدمج

### 3. مرحلة التنفيذ
- يتم الخصم الفعلي من جدول `packaging_materials` في قاعدة البيانات
- يتم تسجيل العملية في `packaging_usage_logs` (إن وجد)
- يتم تسجيل جميع العمليات في سجلات النظام (error_log)

---

## الميزات

### ✅ موثوقية عالية
- البحث عن المواد بعدة طرق لضمان الاكتشاف الصحيح
- معالجة الأخطاء بشكل آمن

### ✅ مرونة في الحساب
- استخدام `intdiv()` للقسمة الصحيحة
- دعم مضاعفات الأرقام (12، 24، 36... أو 6، 12، 18...)

### ✅ تسجيل شامل
- تسجيل جميع العمليات في سجلات النظام
- رسائل واضحة لتتبع المشاكل

### ✅ دمج ذكي
- محاولة دمج الكمية المخصومة مع عنصر موجود
- إضافة عنصر جديد فقط عند الحاجة

---

## القواعد المطبقة

| المادة المحفزة | المادة المستهدفة | الشرط | معدل الخصم |
|---------------|------------------|-------|------------|
| PKG-042 | PKG-001 | >= 12 | 1 لكل 12 وحدة |
| PKG-011 | PKG-001 | >= 12 | 1 لكل 12 وحدة |
| PKG-036 | PKG-002 | >= 6 | 1 لكل 6 وحدة |

---

## القواعد الموجودة مسبقاً (للإشارة)

| المادة المحفزة | المادة المستهدفة | الشرط | معدل الخصم |
|---------------|------------------|-------|------------|
| PKG-009 | PKG-001 | >= 12 | 1 لكل 12 وحدة |
| PKG-004 | PKG-001 | >= 12 | 1 لكل 12 وحدة |
| PKG-010 | PKG-002 | >= 6 | 1 لكل 6 وحدة |
| PKG-003 | PKG-002 | >= 24 | 1 لكل 24 وحدة |
| PKG-007 | PKG-041 | >= 24 | 1 لكل 24 وحدة |
| PKG-005 | PKG-041 | >= 18 | 1 لكل 18 وحدة |
| PKG-006 | PKG-041 | >= 18 | 1 لكل 18 وحدة |
| PKG-012 | PKG-041 | >= 24 | 1 لكل 24 وحدة |

---

## ملاحظات تقنية

1. **الموقع في الكود:**
   - المتغيرات: السطور 2346-2356
   - منطق الاكتشاف: داخل حلقة `foreach ($packagingItems as $pkg)`
   - منطق الخصم: بعد حلقة معالجة مواد التعبئة وقبل معالجة المواد الخام

2. **الأمان:**
   - جميع العمليات محمية بـ try-catch
   - التحقق من وجود الجداول قبل الاستخدام
   - التحقق من صحة البيانات قبل المعالجة

3. **الأداء:**
   - استخدام cache للبحث عن المواد
   - تجنب البحث المكرر
   - دمج العناصر لتقليل عدد السجلات

---

## الاختبار

للتحقق من عمل النظام:
1. إنشاء قالب يحتوي على PKG-042 أو PKG-011 أو PKG-036
2. إنشاء تشغيلة إنتاج بكمية مناسبة (>= 12 أو >= 6)
3. التحقق من:
   - ظهور رسائل الاكتشاف في السجلات
   - إضافة المادة المستهدفة تلقائياً
   - الخصم الصحيح من المخزون

---

## تاريخ التعديلات
- **PKG-042 → PKG-001:** تم التطبيق
- **PKG-011 → PKG-001:** تم التطبيق
- **PKG-036 → PKG-002:** تم التطبيق

---

## الملف المعدل
- `modules/production/production.php` (حوالي 9751 سطر)

